:javascript
  var twitter_max_id = 1;
  var facebook_since = 0;
  
  // Reverse sort (newest on top)
  function compare(a, b) {
    if (a['timestamp'] < b['timestamp'])
      return -1
    if (a['timestamp'] > b['timestamp'])
      return 1;
    return 0;
  }
  
  // Callback that is run when all feeds have loaded.
  function feedsLoaded(twitterArgs, facebookArgs) {
    var twitter = twitterArgs[0];
    var facebook = facebookArgs[0];

    var items = [];

    if (twitter.length > 0) {
      twitter_max_id = twitter[0]['id_str'];
    }

    $.each(twitter, function(key, value) {
      var item = {};
      item['timestamp'] = Date.parse(value['created_at']);
      item['content'] = '<li class="tweet"><img src="'
        + value['user']['profile_image_url']
        + '" /><div id="tweet_text">'
        + value['text']
        + '</div><div class="twitter_screen_name">'
        + value['user']['screen_name']
        + '</div>';
      items.push(item);
    });

    $.each(facebook, function(key, value) {
      if (value['type'] == 'status') {
        var item = {};
        item['timestamp'] = Date.parse(value['created_time']);
        item['content'] = '<li class="fb"><img src="http://graph.facebook.com/' + value['from']['id'] + '/picture" />'
          + '<div id="fb_text">'
          + value['message']
          + '</div><div class="fb_name">'
          + value['from']['name']
          + '</div></li>';
        items.push(item);
      }
    });
    
    // Sort all feed items by timestamp. Eventually merge sort the lists to be more efficient.
    items.sort(compare);

    // Prepend any new items to the front of the list.
    $.each(items, function(index, item) {
      $('#feed').prepend(item.content);
    });
  }

  // Asynchronously get json feeds.
  function refreshFeed() {
    $.when(
      $.getJSON('/api/twitter_user_timeline.json?since_id=' + twitter_max_id, function(data) {
        return data;
      }),
      $.getJSON('/api/facebook_feed.json?since=' + facebook_since, function(data) {
        return data;
      }
    )).done(feedsLoaded);
  }

  $(document).ready(function() {
    // Refresh feed when document is loaded.
    refreshFeed();

    $("#refresh_button").click(refreshFeed);

    // The 'r' key refreshes the feed.
    $(document).bind('keydown', 'r', refreshFeed);
  });

%h1 simplemerge
%button{:id => "refresh_button"} refresh

%ul{:id => "feed"}
